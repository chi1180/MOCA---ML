# MOCA---ML

過疎地域のバス運行需要予測機械学習システム

## プロジェクト概要

本プロジェクトは、広島県内の過疎地域におけるバス運行の需要を予測する機械学習システムです。停留所ごとの乗客数を高精度に予測することで、効率的なバス運行計画の立案を支援します。

### 主な特徴

- **リアルな過疎地データの模擬生成**: 時間帯・曜日・季節・天候による需要変動を再現
- **包括的な特徴量エンジニアリング**: 周期的特徴、時間特徴、天候特徴、相互作用特徴、ラグ特徴
- **自動機械学習（AutoML）**: PyCaret による効率的なモデル選択と最適化
- **時系列分割による適切な評価**: 未来のデータリークを防ぐ時系列交差検証

## プロジェクト構成

```
space_01/
├── README.md                    # 本ファイル
├── docs/                        # ドキュメント
│   ├── 01_project_overview.md   # プロジェクト概要
│   ├── 02_data_generation.md    # ダミーデータ生成の詳細
│   ├── 03_feature_engineering.md # 特徴量エンジニアリング
│   ├── 04_model_training.md     # モデル学習と評価
│   └── 05_usage_guide.md        # 使い方ガイド
├── data_generator.py            # ダミーデータ生成ロジック
├── gtr.py                       # データ生成実行スクリプト
├── mlm.py                       # 機械学習パイプライン
├── Learning.ipynb               # 探索的データ分析ノートブック
├── pixi.toml                    # 依存関係管理
├── bus_operation_data.csv       # 生成されたデータセット（実行後）
└── figures/                     # 可視化結果（実行後）
```

## クイックスタート

### 1. 環境構築

```bash
# Pixi を使用する場合（推奨）
pixi install

# または pip を使用する場合
pip install pandas numpy scipy scikit-learn pycaret==3.3.2 tensorflow matplotlib seaborn
```

### 2. ダミーデータの生成

```bash
python gtr.py
```

停留所データから1年分のバス運行データ（約62,000レコード）を生成し、`bus_operation_data.csv` に保存します。

### 3. モデルの学習

```bash
python mlm.py
```

生成されたデータを使用して機械学習モデルを学習し、予測精度を評価します。

### 4. 探索的分析

```bash
jupyter notebook Learning.ipynb
```

データの詳細な分析と可視化を行います。

## ドキュメント

詳細なドキュメントは `docs/` フォルダ内に整理されています。

### 📚 ドキュメント一覧

1. **[プロジェクト概要](docs/01_project_overview.md)**
   - プロジェクトの目的と背景
   - 技術スタック
   - ユースケース
   - データフロー

2. **[ダミーデータ生成の詳細](docs/02_data_generation.md)** ⭐
   - データ生成の流れ
   - 需要計算ロジック（基礎需要、時間帯係数、休日係数、気象係数）
   - 気象データ生成（気温・降水量）
   - ゼロ膨張の実装
   - データ品質検証
   - 具体的な生成例

3. **[特徴量エンジニアリング](docs/03_feature_engineering.md)**
   - 周期的特徴量（sin/cos変換）
   - 時間特徴量（時間帯区分、季節など）
   - 天候特徴量（降水量・気温カテゴリ）
   - 相互作用特徴量（複数特徴の組み合わせ）
   - ラグ特徴量（過去の需要データ）
   - カテゴリカル変数のエンコーディング

4. **[モデル学習と評価](docs/04_model_training.md)**
   - 時系列分割の重要性
   - PyCaret を使用した AutoML
   - モデル評価指標（MAE, RMSE, R²）
   - セグメント別評価
   - 交差検証
   - 可視化と特徴量重要度

5. **[使い方ガイド](docs/05_usage_guide.md)**
   - 環境構築の詳細手順
   - カスタムデータ生成
   - 特徴量のカスタマイズ
   - モデルの選択とチューニング
   - 予測の実行方法
   - トラブルシューティング
   - よくある質問（FAQ）

6. **[データセットリファレンス](docs/06_dataset_reference.md)** 📊
   - bus_operation_data.csv の詳細解説
   - 全カラムの説明と値の範囲
   - データの特徴と統計
   - 過疎地特有のパターン（ゼロ膨張、時間帯別・曜日別需要）
   - データの使用例とサンプルコード
   - データの制約と注意点

7. **[Jupyter Notebook ガイド](docs/07_notebook_guide.md)** 📓
   - Learning.ipynb の使い方
   - 各セルの詳細解説
   - PyCaret セットアップの説明
   - 追加の分析例（可視化、モデル実験）
   - トラブルシューティング
   - ベストプラクティス

## ダミーデータ生成の仕組み

### 需要計算の基本式

乗客数はポアソン分布を使用して生成されます。ポアソン分布のパラメータλ（平均乗客数）は、以下の4つの要因の積で決定されます。

```
λ = 基礎需要 × 時間帯係数 × 休日係数 × 気象係数
乗客数 = Poisson(λ)
```

### 4つの需要係数

#### 1. 基礎需要

- **拠点（役場、駅など）**: 3.0
- **通常の停留所**: 1.5

#### 2. 時間帯係数

停留所タイプと時刻の組み合わせで変動：

- **get_on（住宅地）**: 朝7-8時にピーク（2.5倍）
- **get_off（目的地）**: 朝8-9時、夕方17-19時にピーク（2.0-2.5倍）
- **get_on_off（ターミナル）**: 朝7-9時、夕方17-19時にピーク（2.5倍）

#### 3. 休日係数

過疎地では休日の需要が大幅に減少：

- **平日**: 1.0（変化なし）
- **休日**: 0.4-0.6（停留所タイプによる）

#### 4. 気象係数

降水量による需要変動：

- **晴天**: 1.0（変化なし）
- **雨天**: 0.9-1.3（停留所タイプによる）

### 具体例

**条件**:

- 7月15日（土曜日）8時
- 停留所: "駅前" (get_on_off, is_base_point=True)
- 気温: 25.3℃、降水量: 5.2mm（雨）

**計算**:

```
λ = 3.0 × 2.5 × 0.6 × 1.3 = 5.85
乗客数 = Poisson(5.85) → 例: 6人
```

### 過疎地特有の特徴

- **ゼロ膨張**: 拠点以外の停留所では20%の確率で乗客数を0に設定
- **季節性**: 月ごとの気温・降水量パターン
- **再現性**: 乱数シード（SEED=42）による同一データの再生成

詳細は [ダミーデータ生成の詳細ドキュメント](docs/02_data_generation.md) を参照してください。

## 生成されるデータの構造

| カラム名        | 型      | 説明                                      |
| --------------- | ------- | ----------------------------------------- |
| date            | date    | 日付                                      |
| hour            | int8    | 時刻（6-22）                              |
| stop_id         | string  | 停留所ID（UUID）                          |
| stop_name       | string  | 停留所名                                  |
| stop_type       | string  | 停留所タイプ（get_on/get_off/get_on_off） |
| latitude        | float64 | 緯度                                      |
| longitude       | float64 | 経度                                      |
| is_base_point   | int8    | 拠点フラグ（0 or 1）                      |
| month           | int8    | 月（1-12）                                |
| day_of_week     | int8    | 曜日（0=月曜 〜 6=日曜）                  |
| is_holiday      | int8    | 休日フラグ（0 or 1）                      |
| temperature     | float32 | 気温（℃）                                 |
| precipitation   | float32 | 降水量（mm）                              |
| passenger_count | int16   | 乗客数（予測対象）                        |

## データ統計（例）

```
総レコード数: 62,050
期間: 2025-01-01 ~ 2025-12-31
停留所数: 10

乗客数統計:
  平均: 1.85人
  中央値: 1.0人
  最大: 15人
  最小: 0人
  ゼロの割合: 35.2%

時間帯別平均乗客数:
  7時: 2.85人（朝ピーク）
  8時: 3.12人（朝ピーク）
  12時: 1.45人（昼間）
  17時: 2.94人（夕方ピーク）
  18時: 3.01人（夕方ピーク）
```

## 技術スタック

- **Python**: 3.10
- **データ処理**: pandas, NumPy
- **機械学習**: PyCaret 3.3.2, scikit-learn
- **深層学習**: TensorFlow 2.15+
- **可視化**: matplotlib, seaborn
- **パッケージ管理**: Pixi

## モデル性能

過疎地バス需要予測での典型的な性能：

- **MAE（平均絶対誤差）**: 0.8 〜 1.2人
- **RMSE（二乗平均平方根誤差）**: 1.3 〜 1.8人
- **R²（決定係数）**: 0.65 〜 0.75

## ユースケース

- **バス運行事業者**: 効率的な運行計画の立案
- **地方自治体**: 公共交通政策の意思決定支援
- **研究者**: 過疎地域の交通需要分析

## 今後の展開

1. **深層学習の導入**: LSTM, Transformer による時系列モデリング
2. **外部データの統合**: リアルタイム気象API、イベント情報
3. **オンライン学習**: 新しいデータでモデルを継続的に更新
4. **Webアプリケーション**: 予測結果の可視化ダッシュボード
5. **API化**: RESTful API による予測サービスの提供

## ライセンス

MIT License

## 作者

Hiroshima AI Club 2025

## 参考リンク

- [PyCaret Documentation](https://pycaret.gitbook.io/docs/)
- [pandas Documentation](https://pandas.pydata.org/docs/)
- [scikit-learn Documentation](https://scikit-learn.org/stable/)

## サポート

問題や質問がある場合は、プロジェクトのIssueセクションで報告してください。
